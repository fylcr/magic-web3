# .github/workflows/publish-all-docs-to-readme.yml
name: Publish All Docs to ReadMe (no Node.js)

on:
  push:
    branches:
      - docs
  workflow_dispatch:

env:
  READMECOM_API_BASE: https://dash.readme.com/api/v1

jobs:
  publish-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: docs

      - name: Find and upload all MD/MDX files
        env:
          API_KEY: ${{ secrets.README_API_KEY }}
          PROJECT: "<your-project-id>"    # 可选：如果你有多个项目，填这里
        run: |
          set -euo pipefail

          # 扫描 docs 下的所有 .md 和 .mdx 文件
          find docs -type f \( -iname '*.md' -o -iname '*.mdx' \) | while read -r filepath; do
            # 生成 slug：去掉 docs/ 前缀和后缀
            slug=$(echo "$filepath" | sed -e 's|^docs/||' -e 's|\.[Mm][Dd][Xx]\?$||')
            echo "→ Processing $filepath (slug: $slug)"

            # 读取并 JSON-encode 文件内容
            body=$(jq -Rs . < "$filepath")

            # 查询是否已经存在同名页面
            resp=$(curl -s -G \
              --data-urlencode "slug=$slug" \
              "$READMECOM_API_BASE/content" \
              -H "Authorization: Basic $API_KEY")
            id=$(echo "$resp" | jq -r '.[0].id // empty')

            if [ -z "$id" ]; then
              echo "   • Creating new page"
              curl -s -X POST "$READMECOM_API_BASE/content" \
                -H "Authorization: Basic $API_KEY" \
                -H "Content-Type: application/json" \
                -d '{
                  "project": "'"${PROJECT}"'",
                  "category": "guides",
                  "slug": "'"${slug}"'",
                  "title": "'"${slug//-/ }"'",
                  "body": '"$body"'
                }'
            else
              echo "   • Updating page ID $id"
              curl -s -X PUT "$READMECOM_API_BASE/content/$id" \
                -H "Authorization: Basic $API_KEY" \
                -H "Content-Type: application/json" \
                -d '{
                  "body": '"$body"'
                }'
            fi

            echo
          done

      - name: Done
        run: echo "✅ All docs (.md & .mdx) have been synced to ReadMe.com"
